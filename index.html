<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¦ªå¸«ç”Ÿäº’å‹•ç³»çµ±V2</title>
    <style>
        /* ================= CSS æ¨£å¼å€ ================= */
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 480px; margin: 0 auto; }
        .page-title { font-size: 24px; font-weight: 600; text-align: center; margin-bottom: 30px; color: #2c3e50; margin-top: 10px; }
        .result-card { background: #ffffff; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .label { font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 500; }
        .input-field { background: #f9f9f9; border: 1px solid #eee; height: 48px; width: 100%; padding: 0 15px; border-radius: 10px; box-sizing: border-box; font-size: 16px; margin-bottom: 20px; outline: none; transition: border 0.3s; }
        .input-field:focus { border-color: #07c160; background: #fff; }
        .input-area { background: #f9f9f9; border: 1px solid #eee; width: 100%; height: 100px; padding: 15px; border-radius: 10px; box-sizing: border-box; font-size: 16px; margin-bottom: 20px; resize: none; outline: none; }
        .btn { background-color: #07c160; color: white; border: none; width: 100%; height: 48px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(7, 193, 96, 0.2); margin-bottom: 15px; }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background-color: #f5f5f5; color: #666; box-shadow: none; }
        .btn-upload { background-color: #e0e0e0; color: #333; box-shadow: none; }
        .hidden { display: none; }
        .link-text { color: #576b95; font-size: 14px; text-decoration: underline; cursor: pointer; }
        .text-break { word-break: break-all; white-space: pre-wrap; line-height: 1.5; }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #07c160; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        img.preview { width: 100%; height: 200px; object-fit: contain; background: #eee; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div id="loading-text">è™•ç†ä¸­...</div>
    </div>

    <div id="page-login">
        <div class="page-title">è¦ªå¸«ç”Ÿäº’å‹•ç³»çµ±v2</div>
        <div class="result-card">
            <div class="label">å¸³è™Ÿ</div>
            <input type="text" id="login-id" class="input-field" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
            <div class="label">å¯†ç¢¼</div>
            <input type="password" id="login-pwd" class="input-field" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            <button class="btn" onclick="doLogin()">ç™»å…¥</button>
        </div>
        <div style="text-align:center; margin-top:20px;">
            <span class="link-text" onclick="showPage('register')">æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š</span>
        </div>
    </div>

    <div id="page-register" class="hidden">
        <div class="page-title">è¨»å†Šæ–°å¸³è™Ÿ</div>
        <div class="result-card">
            <input type="text" id="reg-id" class="input-field" placeholder="è¨­å®šå¸³è™Ÿ (ä¾‹å¦‚å­¸è™Ÿ)">
            <input type="password" id="reg-pwd" class="input-field" placeholder="è¨­å®šå¯†ç¢¼">
            <input type="text" id="reg-name" class="input-field" placeholder="æ‚¨çš„å§“å">
            
            <div style="margin: 20px 0; display:flex; gap:20px;">
                <label style="display:flex; align-items:center;"><input type="radio" name="role" value="student" checked> å­¸ç”Ÿ</label>
                <label style="display:flex; align-items:center;"><input type="radio" name="role" value="parent"> å®¶é•·</label>
            </div>

            <button class="btn" onclick="doRegister()">è¨»å†Šä¸¦è¿”å›</button>
        </div>
        <button class="btn btn-secondary" onclick="showPage('login')">å–æ¶ˆ</button>
    </div>

    <div id="page-dashboard" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="font-weight:bold; font-size:18px;">Hi, <span id="user-name"></span></div>
            <button class="btn btn-secondary" style="width:auto; height:36px; margin:0;" onclick="doLogout()">ç™»å‡º</button>
        </div>

        <div id="view-student" class="hidden">
            <div class="result-card">
                <div style="font-weight:bold; margin-bottom:15px; font-size:18px;">ğŸ“ ä»Šæ—¥ä½œæ¥­ä¸Šå‚³</div>
                <textarea id="student-answer" class="input-area" placeholder="è«‹è¼¸å…¥ä»Šæ—¥å›ç­”..."></textarea>
                
                <img id="img-preview" class="preview hidden">
                <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileSelect(event)">
                
                <button class="btn btn-upload" onclick="document.getElementById('file-input').click()">ğŸ“· æ‹ç…§æˆ–é¸åœ–</button>
                <button class="btn" onclick="doUpload()">é€å‡ºä½œæ¥­</button>
            </div>
        </div>

        <div id="view-parent" class="hidden">
            <div id="parent-bind" class="result-card hidden" style="text-align:center;">
                <div style="margin-bottom:20px; font-size:18px;">æ‚¨å°šæœªç¶å®šå­©å­å¸³è™Ÿ</div>
                <input type="text" id="child-id" class="input-field" placeholder="è«‹è¼¸å…¥å­©å­çš„å¸³è™Ÿ">
                <button class="btn" onclick="doBindChild()">ç¶å®š</button>
            </div>

            <div id="parent-data" class="hidden">
                <div style="margin-bottom:15px; font-weight:bold; color:#333; font-size:18px;">ğŸ‘¶ å­©å­ä»Šæ—¥å­¸ç¿’ç‹€æ³</div>
                
                <div id="query-result-card" class="result-card hidden">
                    <div class="label">ä¸Šå‚³æ™‚é–“</div>
                    <div id="res-time" class="text-break" style="margin-bottom:15px;"></div>
                    <div class="label">å§“å</div>
                    <div id="res-name" class="text-break" style="margin-bottom:15px;"></div>
                    <div class="label" style="border-top:1px solid #eee; padding-top:10px;">ä½œæ¥­å›ç­”</div>
                    <div id="res-answer" class="text-break" style="margin-bottom:15px;"></div>
                    
                    <div id="res-photo-box" class="hidden" style="background:#f0f8ff; padding:10px; border-radius:8px;">
                        <div class="label">ğŸ–¼ï¸ ç…§ç‰‡é€£çµ</div>
                        <a id="res-photo-link" href="#" target="_blank" class="link-text text-break">é»æ“ŠæŸ¥çœ‹ç…§ç‰‡</a>
                    </div>
                </div>

                <div id="no-data-msg" class="hidden" style="text-align:center; color:#999; margin:40px 0;">
                    å­©å­ä»Šå¤©é‚„æ²’ä¸Šå‚³ä½œæ¥­å–”ï¼
                </div>

                <button class="btn btn-secondary" onclick="refreshQuery()">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ğŸ”´ é€™è£¡è«‹è²¼ä¸Šä½ å‰›å‰›åœ¨ç€è¦½å™¨æ‰“é–‹èƒ½çœ‹åˆ°ã€Œâœ… ç³»çµ±é€£ç·šæˆåŠŸ...ã€çš„é‚£å€‹ç¶²å€ï¼
    const API_URL = 'https://script.google.com/macros/s/AKfycbz_N2pDxYIpFK1TXOESWsq_31rYHxH9A9dDPAsXqFh9ovsySir8LNb2oFftosOeLB-U/exec';

    let currentUser = null;
    let base64Image = "";

    function showPage(pageId) {
        ['page-login', 'page-register', 'page-dashboard'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById('page-' + pageId).classList.remove('hidden');
    }

    function toggleLoading(show) {
        const el = document.getElementById('loading');
        if(show) el.classList.remove('hidden');
        else el.classList.add('hidden');
    }

    // --- API å‘¼å« (ä¿®æ­£ç‰ˆï¼šè§£æ±ºå¡æ­»å•é¡Œ) ---
    function callApi(data, onSuccess) {
        toggleLoading(true);
        
        // ä½¿ç”¨ text/plain é¿å… Google Script æ‹’çµ• CORS é æª¢
        fetch(API_URL, {
            method: 'POST',
            headers: {
                "Content-Type": "text/plain;charset=utf-8" 
            },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(response => {
            toggleLoading(false);
            if (response.status === 'success') {
                onSuccess(response);
            } else {
                alert('ç³»çµ±è¨Šæ¯: ' + response.message);
            }
        })
        .catch(err => {
            toggleLoading(false);
            console.error(err);
            // å¦‚æœå¾Œç«¯é€£ç·šæˆåŠŸï¼Œä½†è™•ç†é‚è¼¯å‡ºéŒ¯ï¼Œé€šå¸¸ä¸æœƒé€²åˆ°é€™è£¡
            // é€™è£¡é€šå¸¸æ˜¯ç¶²è·¯æ–·ç·šæˆ–ç¶²å€éŒ¯èª¤
            alert('é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€æ˜¯å¦æ­£ç¢ºæ›´æ–°åˆ° index.html');
        });
    }

    // --- è¨»å†Š ---
    function doRegister() {
        const id = document.getElementById('reg-id').value;
        const pwd = document.getElementById('reg-pwd').value;
        const name = document.getElementById('reg-name').value;
        const role = document.querySelector('input[name="role"]:checked').value;
        if(!id || !pwd || !name) return alert('è«‹å¡«å¯«å®Œæ•´');
        callApi({ action: 'register', id, password: pwd, name, role }, () => {
            alert('è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥');
            showPage('login');
        });
    }

    // --- ç™»å…¥ ---
    function doLogin() {
        const id = document.getElementById('login-id').value;
        const pwd = document.getElementById('login-pwd').value;
        if(!id || !pwd) return alert('è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼');
        callApi({ action: 'login', id, password: pwd }, (res) => {
            currentUser = res.user;
            document.getElementById('user-name').innerText = currentUser.name;
            showPage('dashboard');
            document.getElementById('view-student').classList.add('hidden');
            document.getElementById('view-parent').classList.add('hidden');
            if (currentUser.role === 'student') {
                document.getElementById('view-student').classList.remove('hidden');
            } else {
                document.getElementById('view-parent').classList.remove('hidden');
                checkParentState();
            }
        });
    }

    function doLogout() {
        currentUser = null;
        document.getElementById('login-id').value = '';
        document.getElementById('login-pwd').value = '';
        showPage('login');
    }

    // --- å­¸ç”ŸåŠŸèƒ½ ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                base64Image = e.target.result.split(',')[1];
                const img = document.getElementById('img-preview');
                img.src = e.target.result;
                img.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    function doUpload() {
        const answer = document.getElementById('student-answer').value;
        callApi({
            action: 'upload',
            id: currentUser.id,
            name: currentUser.name,
            answer: answer,
            image_data: base64Image
        }, () => {
            alert('ä¸Šå‚³æˆåŠŸï¼');
            document.getElementById('student-answer').value = '';
            document.getElementById('img-preview').classList.add('hidden');
            base64Image = "";
        });
    }

    // --- å®¶é•·åŠŸèƒ½ ---
    function checkParentState() {
        if (!currentUser.childId) {
            document.getElementById('parent-bind').classList.remove('hidden');
            document.getElementById('parent-data').classList.add('hidden');
        } else {
            document.getElementById('parent-bind').classList.add('hidden');
            document.getElementById('parent-data').classList.remove('hidden');
            refreshQuery();
        }
    }

    function doBindChild() {
        const childId = document.getElementById('child-id').value;
        if(!childId) return;
        callApi({ action: 'bind', parentId: currentUser.id, childId }, (res) => {
            currentUser.childId = res.childId;
            alert('ç¶å®šæˆåŠŸ');
            checkParentState();
        });
    }

    function refreshQuery() {
        if(!currentUser.childId) return;
        callApi({ action: 'query', targetId: currentUser.childId }, (res) => {
            document.getElementById('no-data-msg').classList.add('hidden');
            document.getElementById('query-result-card').classList.remove('hidden');
            const d = res.data;
            document.getElementById('res-time').innerText = new Date(d.time).toLocaleString();
            document.getElementById('res-name').innerText = d.name;
            document.getElementById('res-answer').innerText = d.answer;
            if (d.photoUrl && d.photoUrl !== 'ç„¡ç…§ç‰‡') {
                document.getElementById('res-photo-box').classList.remove('hidden');
                document.getElementById('res-photo-link').href = d.photoUrl;
            } else {
                document.getElementById('res-photo-box').classList.add('hidden');
            }
        }); 
    }
</script>

</body>

</html>
