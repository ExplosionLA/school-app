<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¦ªå¸«ç”Ÿäº’å‹•ç³»çµ±v3</title>
    <style>
        /* ================= CSS æ¨£å¼å€ ================= */
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 480px; margin: 0 auto; }
        .page-title { font-size: 24px; font-weight: 600; text-align: center; margin-bottom: 30px; color: #2c3e50; margin-top: 10px; }
        .result-card { background: #ffffff; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .label { font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 500; }
        .input-field { background: #f9f9f9; border: 1px solid #eee; height: 48px; width: 100%; padding: 0 15px; border-radius: 10px; box-sizing: border-box; font-size: 16px; margin-bottom: 20px; outline: none; transition: border 0.3s; }
        .input-field:focus { border-color: #07c160; background: #fff; }
        .input-area { background: #f9f9f9; border: 1px solid #eee; width: 100%; height: 100px; padding: 15px; border-radius: 10px; box-sizing: border-box; font-size: 16px; margin-bottom: 20px; resize: none; outline: none; }
        .btn { background-color: #07c160; color: white; border: none; width: 100%; height: 48px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(7, 193, 96, 0.2); margin-bottom: 15px; }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background-color: #f5f5f5; color: #666; box-shadow: none; }
        .btn-upload { background-color: #e0e0e0; color: #333; box-shadow: none; }
        .hidden { display: none; }
        .text-break { word-break: break-all; white-space: pre-wrap; line-height: 1.5; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #07c160; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        img.preview { width: 100%; height: 200px; object-fit: contain; background: #eee; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div id="loading-text">è™•ç†ä¸­...</div>
    </div>

    <div id="page-login">
        <div class="page-title">è¦ªå¸«ç”Ÿäº’å‹•ç³»çµ±v3</div>
        <div class="result-card">
            <div class="label">å¸³è™Ÿ</div>
            <input type="text" id="login-id" class="input-field" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
            <div class="label">å¯†ç¢¼</div>
            <input type="password" id="login-pwd" class="input-field" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            <button class="btn" onclick="doLogin()">ç™»å…¥</button>
        </div>
        <div style="text-align:center; margin-top:20px;">
            <span style="color:#576b95;cursor:pointer;" onclick="showPage('register')">æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š</span>
        </div>
    </div>

    <div id="page-register" class="hidden">
        <div class="page-title">è¨»å†Šæ–°å¸³è™Ÿ</div>
        <div class="result-card">
            <input type="text" id="reg-id" class="input-field" placeholder="è¨­å®šå¸³è™Ÿ">
            <input type="password" id="reg-pwd" class="input-field" placeholder="è¨­å®šå¯†ç¢¼">
            <input type="text" id="reg-name" class="input-field" placeholder="æ‚¨çš„å§“å">
            <div style="margin: 20px 0; display:flex; gap:20px;">
                <label><input type="radio" name="role" value="student" checked> å­¸ç”Ÿ</label>
                <label><input type="radio" name="role" value="parent"> å®¶é•·</label>
            </div>
            <button class="btn" onclick="doRegister()">è¨»å†Š</button>
        </div>
        <button class="btn btn-secondary" onclick="showPage('login')">å–æ¶ˆ</button>
    </div>

    <div id="page-dashboard" class="hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <div style="font-weight:bold;">Hi, <span id="user-name"></span></div>
            <div style="color:red;cursor:pointer;" onclick="doLogout()">ç™»å‡º</div>
        </div>
        <div id="view-student" class="hidden">
            <div class="result-card">
                <textarea id="student-answer" class="input-area" placeholder="è¼¸å…¥å›ç­”..."></textarea>
                <img id="img-preview" class="preview hidden">
                <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileSelect(event)">
                <button class="btn btn-upload" onclick="document.getElementById('file-input').click()">ğŸ“· æ‹ç…§/é¸åœ–</button>
                <button class="btn" onclick="doUpload()">é€å‡ºä½œæ¥­</button>
            </div>
        </div>
        <div id="view-parent" class="hidden">
            <div id="parent-bind" class="result-card hidden">
                <input type="text" id="child-id" class="input-field" placeholder="å­©å­å¸³è™Ÿ">
                <button class="btn" onclick="doBindChild()">ç¶å®š</button>
            </div>
            <div id="parent-data" class="hidden">
                <div id="query-result-card" class="result-card">
                    <div id="res-content" class="text-break">æ­£åœ¨è®€å–...</div>
                </div>
                <button class="btn btn-secondary" onclick="refreshQuery()">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ğŸ”´ å¿…é ˆç¢ºä¿é€™ä¸²ç¶²å€æ­£ç¢ºä¸”çµå°¾æ˜¯ /exec
    const API_URL = 'https://script.google.com/macros/s/AKfycbz_N2pDxYIpFK1TXOESWsq_31rYHxH9A9dDPAsXqFh9ovsySir8LNb2oFftosOeLB-U/exec';

    let currentUser = null;
    let base64Image = "";

    function showPage(pageId) {
        ['page-login', 'page-register', 'page-dashboard'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('page-' + pageId).classList.remove('hidden');
    }

    function toggleLoading(show) {
        document.getElementById('loading').classList.toggle('hidden', !show);
    }

    // --- åŠ å¼·ç‰ˆ API å‘¼å« ---
    function callApi(data, onSuccess) {
        console.log("å˜—è©¦ç™¼é€è«‹æ±‚:", data.action);
        toggleLoading(true);

        fetch(API_URL, {
            method: 'POST',
            mode: 'cors', // ç¢ºä¿ä½¿ç”¨è·¨ç¶²åŸŸæ¨¡å¼
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(data)
        })
        .then(res => {
            console.log("æ”¶åˆ°å›æ‡‰ç‹€æ…‹:", res.status);
            return res.json();
        })
        .then(res => {
            console.log("å¾Œç«¯è³‡æ–™:", res);
            toggleLoading(false);
            if (res.status === 'success') onSuccess(res);
            else alert("ç³»çµ±è¨Šæ¯: " + res.message);
        })
        .catch(err => {
            console.error("é€£ç·šéŒ¯èª¤:", err);
            toggleLoading(false);
            alert("é€£ç·šå¤±æ•—ï¼è«‹æª¢æŸ¥ï¼š\n1. Google Script æ¬Šé™æ˜¯å¦è¨­ç‚ºã€Œä»»ä½•äººã€\n2. ç¶²å€æ˜¯å¦è¤‡è£½æ­£ç¢º");
        });
    }

    function doLogin() {
        const id = document.getElementById('login-id').value;
        const pwd = document.getElementById('login-pwd').value;
        if(!id || !pwd) return alert("è«‹è¼¸å…¥å¸³å¯†");
        callApi({ action: 'login', id, password: pwd }, res => {
            currentUser = res.user;
            document.getElementById('user-name').innerText = currentUser.name;
            showPage('dashboard');
            if (currentUser.role === 'student') {
                document.getElementById('view-student').classList.remove('hidden');
                document.getElementById('view-parent').classList.add('hidden');
            } else {
                document.getElementById('view-student').classList.add('hidden');
                document.getElementById('view-parent').classList.remove('hidden');
                checkParentState();
            }
        });
    }

    function doRegister() {
        const id = document.getElementById('reg-id').value;
        const pwd = document.getElementById('reg-pwd').value;
        const name = document.getElementById('reg-name').value;
        const role = document.querySelector('input[name="role"]:checked').value;
        callApi({ action: 'register', id, password: pwd, name, role }, () => {
            alert("è¨»å†ŠæˆåŠŸ");
            showPage('login');
        });
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            base64Image = e.target.result.split(',')[1];
            document.getElementById('img-preview').src = e.target.result;
            document.getElementById('img-preview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function doUpload() {
        const answer = document.getElementById('student-answer').value;
        callApi({ action: 'upload', id: currentUser.id, name: currentUser.name, answer, image_data: base64Image }, () => {
            alert("ä¸Šå‚³æˆåŠŸ");
            document.getElementById('student-answer').value = "";
            document.getElementById('img-preview').classList.add('hidden');
            base64Image = "";
        });
    }

    function checkParentState() {
        const bindView = document.getElementById('parent-bind');
        const dataView = document.getElementById('parent-data');
        if (!currentUser.childId) {
            bindView.classList.remove('hidden');
            dataView.classList.add('hidden');
        } else {
            bindView.classList.add('hidden');
            dataView.classList.remove('hidden');
            refreshQuery();
        }
    }

    function doBindChild() {
        const cid = document.getElementById('child-id').value;
        callApi({ action: 'bind', parentId: currentUser.id, childId: cid }, res => {
            currentUser.childId = res.childId;
            alert("ç¶å®šæˆåŠŸ");
            checkParentState();
        });
    }

    function refreshQuery() {
        callApi({ action: 'query', targetId: currentUser.childId }, res => {
            const d = res.data;
            let html = `<div>æ™‚é–“ï¼š${new Date(d.time).toLocaleString()}</div>`;
            html += `<div>å§“åï¼š${d.name}</div>`;
            html += `<div style="margin-top:10px;">å›ç­”ï¼š${d.answer}</div>`;
            if(d.photoUrl && d.photoUrl !== 'ç„¡ç…§ç‰‡') {
                html += `<div style="margin-top:10px;"><a href="${d.photoUrl}" target="_blank" style="color:#007aff;">æŸ¥çœ‹ç…§ç‰‡</a></div>`;
            }
            document.getElementById('res-content').innerHTML = html;
        });
    }

    function doLogout() { location.reload(); }
</script>
</body>
</html>
